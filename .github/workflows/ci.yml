# # name: Run Backend Tests

# # on:
# #   push:
# #     branches: [main]
# #   pull_request:
# #     branches: [main]

# # jobs:
# #   test:
# #     runs-on: ubuntu-latest

# #     steps:
# #       - name: ğŸ“¥ Checkout repository
# #         uses: actions/checkout@v3

# #       - name: ğŸŸ¨ Setup Node.js
# #         uses: actions/setup-node@v3
# #         with:
# #           node-version: 20

# #       - name: ğŸ“¦ Install dependencies
# #         run: npm install
# #         working-directory: ./backend

# #       - name: ğŸ§ª Run tests
# #         run: npm test -- users/
# #         working-directory: ./backend
# name: CI/CD Pipeline

# on:
#   push:
#     branches: [main]
#   pull_request:
#     branches: [main]

# jobs:
#   backend-tests:
#     name: ğŸ” Backend Tests
#     runs-on: ubuntu-latest
#     services:
#       postgres:
#         image: postgres:15
#         env:
#           POSTGRES_DB: trackpro
#           POSTGRES_USER: postgres
#           POSTGRES_PASSWORD: password
#         ports:
#           - 5432:5432
#         options: >-
#           --health-cmd="pg_isready"
#           --health-interval=10s
#           --health-timeout=5s
#           --health-retries=5

#     steps:
#       - name: â¬‡ï¸ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸŸ¨ Use Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       - name: ğŸ“¦ Install dependencies
#         working-directory: ./backend
#         run: npm install

#       - name: âš™ï¸ Wait for PostgreSQL to be ready
#         run: |
#           until pg_isready -h localhost -p 5432 -U postgres; do
#             echo "Waiting for postgres..."
#             sleep 2
#           done

#       - name: ğŸ§ª Run Unit & Functional Tests
#         working-directory: ./backend
#         env:
#           DATABASE_URL: postgres://postgres:password@localhost:5432/trackpro
#         run: npm run test -- users/

#   docker-build:
#     name: ğŸ³ Build Docker Images
#     runs-on: ubuntu-latest
#     needs: backend-tests

#     steps:
#       - name: â¬‡ï¸ Checkout code
#         uses: actions/checkout@v4

#       - name: ğŸ”§ Set up Docker Buildx
#         uses: docker/setup-buildx-action@v3

#       - name: ğŸ§± Build all services (backend, frontend, db)
#         run: docker compose build

# name: ğŸ” CI/CD Pipeline

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# jobs:
#   build-test-deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: ğŸ“‚ Checkout code
#       uses: actions/checkout@v3

#     - name: ğŸ§° Install Docker Compose CLI plugin
#       run: |
#         sudo mkdir -p /usr/local/lib/docker/cli-plugins
#         curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o docker-compose
#         chmod +x docker-compose
#         sudo mv docker-compose /usr/local/lib/docker/cli-plugins/docker-compose
#         docker compose version

#     - name: ğŸŸ¨ Setup Node.js
#       uses: actions/setup-node@v3
#       with:
#         node-version: '18'

#     - name: ğŸ“¦ Install backend dependencies
#       run: |
#         cd backend
#         npm ci

#     - name: ğŸ§ª Run unit tests
#       run: |
#         cd backend
#         npm run test -- users/

#     - name: ğŸ³ Build Docker containers
#       run: docker compose build

#     - name: ğŸš€ Start containers
#       run: docker compose up -d

#     - name: ğŸ› ï¸ Check backend is running
#       run: |
#         sleep 10
#         curl --fail http://localhost:3000 || exit 1

name: CI/CD Docker Compose - TrackPro

on:
  push:
    branches: [main]

jobs:
  test-build-push:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: trackpro
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:password@localhost:5432/trackpro

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: ğŸ§ª Run backend tests
        run: |
          cd backend
          npm run test -- users/

      - name: ğŸ³ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ—ï¸ Build backend image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/trackpro-backend:latest ./backend

      - name: ğŸ—ï¸ Build frontend image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/trackpro-frontend:latest ./frontend

      - name: ğŸš€ Push backend image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/trackpro-backend:latest

      - name: ğŸš€ Push frontend image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/trackpro-frontend:latest
